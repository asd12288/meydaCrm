name: Supabase Preview Setup

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  setup-preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # Wait for Supabase to create the preview branch
      - name: Wait for Supabase Preview Branch
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-supabase
        with:
          checkName: Supabase Preview
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Check Supabase Preview Status
        run: |
          echo "Supabase Preview status: ${{ steps.wait-for-supabase.outputs.conclusion }}"
          # We continue even if Supabase Preview failed because:
          # - The branch might exist but functions failed to deploy
          # - Our job is to fix that by deploying functions ourselves
          if [ "${{ steps.wait-for-supabase.outputs.conclusion }}" == "" ]; then
            echo "Supabase Preview check timed out or not found"
            exit 1
          fi
          echo "Proceeding to deploy Edge Functions and seed data..."

      # Get the preview branch project ref from Supabase API
      - name: Get Preview Branch Info
        id: get-branch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Get branches for the project
          BRANCHES=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            "https://api.supabase.com/v1/projects/${{ secrets.SUPABASE_PROJECT_ID }}/branches")

          # Find the branch matching this PR's git branch
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Looking for branch: $BRANCH_NAME"

          # Extract the project_ref for the matching branch
          PREVIEW_REF=$(echo "$BRANCHES" | jq -r ".[] | select(.git_branch == \"$BRANCH_NAME\") | .project_ref")

          if [ -z "$PREVIEW_REF" ] || [ "$PREVIEW_REF" == "null" ]; then
            echo "Could not find preview branch for: $BRANCH_NAME"
            echo "Available branches:"
            echo "$BRANCHES" | jq -r '.[].git_branch'
            exit 1
          fi

          echo "Found preview branch: $PREVIEW_REF"
          echo "preview_ref=$PREVIEW_REF" >> $GITHUB_OUTPUT

      # Deploy Edge Functions to the preview branch
      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          PREVIEW_REF="${{ steps.get-branch.outputs.preview_ref }}"
          echo "Deploying Edge Functions to preview branch: $PREVIEW_REF"

          # Link to the preview project
          supabase link --project-ref "$PREVIEW_REF"

          # Deploy all functions
          supabase functions deploy admin-create-user --no-verify-jwt=false
          supabase functions deploy admin-reset-password --no-verify-jwt=false
          supabase functions deploy admin-delete-user --no-verify-jwt=false
          supabase functions deploy subscription-webhook --no-verify-jwt=true

          echo "Edge Functions deployed successfully!"

      # Run seed data on the preview branch using Supabase CLI
      - name: Apply Seed Data
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          PREVIEW_REF="${{ steps.get-branch.outputs.preview_ref }}"
          echo "Applying seed data to preview branch: $PREVIEW_REF"

          # Check if seed file exists
          if [ ! -f "supabase/seed.sql" ]; then
            echo "No seed.sql found, skipping seed data"
            exit 0
          fi

          # Link to preview project (already linked from functions deploy, but be explicit)
          supabase link --project-ref "$PREVIEW_REF"

          # Execute seed.sql using Supabase CLI (handles larger files)
          echo "Running seed.sql via Supabase CLI..."
          cat supabase/seed.sql | supabase db execute --project-ref "$PREVIEW_REF" || {
            echo "Warning: Seed data may have partially failed (some data might already exist)"
          }

          echo "Seed data applied!"

      - name: Summary
        run: |
          echo "## Supabase Preview Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview Branch:** ${{ steps.get-branch.outputs.preview_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Edge Functions:** Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Seed Data:** Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: https://${{ steps.get-branch.outputs.preview_ref }}.supabase.co" >> $GITHUB_STEP_SUMMARY
