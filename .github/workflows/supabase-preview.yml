name: Supabase Preview Setup

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  setup-preview:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      # Wait for Supabase to create the preview branch
      - name: Wait for Supabase Preview Branch
        uses: fountainhead/action-wait-for-check@v1.2.0
        id: wait-for-supabase
        with:
          checkName: Supabase Preview
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          timeoutSeconds: 600
          intervalSeconds: 15

      - name: Check if Supabase Preview succeeded
        if: steps.wait-for-supabase.outputs.conclusion != 'success'
        run: |
          echo "Supabase Preview branch creation failed or timed out"
          echo "Status: ${{ steps.wait-for-supabase.outputs.conclusion }}"
          exit 1

      # Get the preview branch project ref from Supabase API
      - name: Get Preview Branch Info
        id: get-branch
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Get branches for the project
          BRANCHES=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            "https://api.supabase.com/v1/projects/${{ secrets.SUPABASE_PROJECT_ID }}/branches")

          # Find the branch matching this PR's git branch
          BRANCH_NAME="${{ github.head_ref }}"
          echo "Looking for branch: $BRANCH_NAME"

          # Extract the project_ref for the matching branch
          PREVIEW_REF=$(echo "$BRANCHES" | jq -r ".[] | select(.git_branch == \"$BRANCH_NAME\") | .project_ref")

          if [ -z "$PREVIEW_REF" ] || [ "$PREVIEW_REF" == "null" ]; then
            echo "Could not find preview branch for: $BRANCH_NAME"
            echo "Available branches:"
            echo "$BRANCHES" | jq -r '.[].git_branch'
            exit 1
          fi

          echo "Found preview branch: $PREVIEW_REF"
          echo "preview_ref=$PREVIEW_REF" >> $GITHUB_OUTPUT

      # Deploy Edge Functions to the preview branch
      - name: Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          PREVIEW_REF="${{ steps.get-branch.outputs.preview_ref }}"
          echo "Deploying Edge Functions to preview branch: $PREVIEW_REF"

          # Link to the preview project
          supabase link --project-ref "$PREVIEW_REF"

          # Deploy all functions
          supabase functions deploy admin-create-user --no-verify-jwt=false
          supabase functions deploy admin-reset-password --no-verify-jwt=false
          supabase functions deploy admin-delete-user --no-verify-jwt=false
          supabase functions deploy subscription-webhook --no-verify-jwt=true

          echo "Edge Functions deployed successfully!"

      # Run seed data on the preview branch using Supabase API
      - name: Apply Seed Data
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          PREVIEW_REF="${{ steps.get-branch.outputs.preview_ref }}"
          echo "Applying seed data to preview branch: $PREVIEW_REF"

          # Check if seed file exists
          if [ ! -f "supabase/seed.sql" ]; then
            echo "No seed.sql found, skipping seed data"
            exit 0
          fi

          # Read seed.sql content
          SEED_SQL=$(cat supabase/seed.sql)

          # Execute SQL via Supabase Management API
          echo "Running seed.sql via Supabase API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": $(echo "$SEED_SQL" | jq -Rs .)}" \
            "https://api.supabase.com/v1/projects/$PREVIEW_REF/database/query")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "Seed data applied successfully!"
          else
            echo "Warning: Seed data may have partially failed"
            echo "Response: $BODY"
            # Don't fail the job - some seed data might already exist
          fi

      - name: Summary
        run: |
          echo "## Supabase Preview Setup Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview Branch:** ${{ steps.get-branch.outputs.preview_ref }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Edge Functions:** Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **Seed Data:** Applied" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Preview URL: https://${{ steps.get-branch.outputs.preview_ref }}.supabase.co" >> $GITHUB_STEP_SUMMARY
